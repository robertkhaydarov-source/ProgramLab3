package com.company.exhibition.service.impl;

import com.company.exhibition.model.*;
import com.company.exhibition.exception.ViewingException;
import com.company.exhibition.metrics.ViewingMetrics;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.util.Assert;

import javax.annotation.PostConstruct;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.locks.ReentrantLock;

@Slf4j
@Service
@RequiredArgsConstructor
public class PictureViewingServiceImpl implements PictureViewingService {
    
    private final ViewingMetrics viewingMetrics;
    private final PictureAnalyticsService analyticsService;
    
    @Value("${viewing.glasses.threshold:3}")
    private int glassesThreshold;
    
    @Value("${viewing.max.attempts:3}")
    private int maxRetryAttempts;
    
    @Value("${viewing.cache.enabled:true}")
    private boolean cacheEnabled;
    
    private final ConcurrentHashMap<String, ViewingStats> viewingCache = new ConcurrentHashMap<>();
    private final ReentrantLock glassesLock = new ReentrantLock();
    
    @PostConstruct
    public void init() {
        log.info("PictureViewingService initialized with threshold: {}", glassesThreshold);
    }
    
    @Override
    public ViewingResult watchPicture(DrPilulkin viewer, Picture picture) throws ViewingException {
        // Валидация входных параметров
        Assert.notNull(viewer, "Viewer must not be null");
        Assert.notNull(picture, "Picture must not be null");
        
        long startTime = System.currentTimeMillis();
        String operationId = generateOperationId(viewer, picture);
        
        try {
            log.debug("Starting picture viewing operation: {}", operationId);
            
            // Проверка состояния зрителя
            if (viewer.isSleeping()) {
                log.warn("Viewer {} is sleeping, operation aborted", viewer.getName());
                viewingMetrics.incrementSkippedViewings();
                return ViewingResult.skipped("VIEWER_SLEEPING");
            }
            
            // Кэширование результатов просмотра
            if (cacheEnabled) {
                ViewingStats cachedStats = viewingCache.get(picture.getId());
                if (cachedStats != null && cachedStats.isRecentlyViewed()) {
                    log.debug("Returning cached viewing result for picture: {}", picture.getId());
                    return processCachedViewing(viewer, picture, cachedStats);
                }
            }
            
            // Основная логика просмотра с retry механизмом
            ViewingResult result = performViewingWithRetry(viewer, picture, operationId);
            
            // Сбор метрик
            viewingMetrics.recordViewingDuration(System.currentTimeMillis() - startTime);
            viewingMetrics.incrementSuccessfulViewings();
            
            // Интеграция с аналитикой
            analyticsService.trackViewingEvent(viewer, picture, result);
            
            log.info("Picture viewing completed successfully: {}", operationId);
            return result;
            
        } catch (Exception e) {
            log.error("Failed to process picture viewing: {}", operationId, e);
            viewingMetrics.incrementFailedViewings();
            throw new ViewingException("Picture viewing failed", e);
        }
    }
    
    private ViewingResult performViewingWithRetry(DrPilulkin viewer, Picture picture, String operationId) {
        int attempts = 0;
        while (attempts < maxRetryAttempts) {
            try {
                return performViewing(viewer, picture);
            } catch (TemporaryFailureException e) {
                attempts++;
                log.warn("Temporary failure on attempt {} for {}: {}", attempts, operationId, e.getMessage());
                if (attempts < maxRetryAttempts) {
                    exponentialBackoff(attempts);
                }
            }
        }
        throw new ViewingException("Max retry attempts exceeded for: " + operationId);
    }
    
    private ViewingResult performViewing(DrPilulkin viewer, Picture picture) {
        boolean wasFunny = picture.isFunny();
        AtomicInteger laughCount = viewer.getLaughCount();
        Clothes glasses = viewer.getGlasses();
        
        // Обработка смешной картины
        if (wasFunny) {
            int newLaughCount = laughCount.incrementAndGet();
            log.debug("Viewer {} laughed at picture {}, total laughs: {}", 
                viewer.getName(), picture.getName(), newLaughCount);
            
            // Надеваем очки при достижении порога
            if (newLaughCount >= glassesThreshold && glasses != null && !viewer.hasGlassesOn()) {
                glassesLock.lock();
                try {
                    if (!viewer.hasGlassesOn()) { // Double-check locking
                        viewer.putOnGlasses();
                        log.info("Viewer {} put on glasses after {} laughs", 
                            viewer.getName(), newLaughCount);
                    }
                } finally {
                    glassesLock.unlock();
                }
            }
        }
        
        // Обновляем статистику картины
        picture.incrementViewCount();
        picture.addViewerReaction(viewer.getName(), wasFunny ? "LAUGHED" : "VIEWED");
        
        // Сохраняем в кэш
        if (cacheEnabled) {
            viewingCache.put(picture.getId(), 
                new ViewingStats(picture.getId(), System.currentTimeMillis(), wasFunny));
        }
        
        return ViewingResult.success(wasFunny, viewer.hasGlassesOn());
    }
    
    private void exponentialBackoff(int attempt) {
        try {
            long delay = (long) Math.pow(2, attempt) * 100;
            Thread.sleep(Math.min(delay, 5000));
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private String generateOperationId(DrPilulkin viewer, Picture picture) {
        return String.format("VIEW-%s-%s-%d", 
            viewer.getName(), picture.getId(), System.currentTimeMillis());
    }
}
